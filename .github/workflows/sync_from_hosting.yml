name: Mirror hosting -> GitHub (4.2 folders)

on:
  schedule:
    - cron: "*/1 * * * *"
  workflow_dispatch:

concurrency:
  group: mirror-4-2
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync from hosting (200=keep/upload, 404=delete, SHA=update)
        shell: bash
        run: |
          set -euo pipefail

          BASE_URL="https://nskmedia.net/rizwan/4.2"
          FILE_NAME="libopenplatform.so"
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36"

          # All folders from your hosting screenshot (+ any already in repo)
          fallback=(GL KR TW VNG BGMI BPSTOPHERE GLITCH LDPLAYER LOG TEST1 TEST2 TEST3 TEST4)

          sync_one () {
            local folder="$1"
            local url="${BASE_URL}/${folder}/${FILE_NAME}"
            local dest="4.2/${folder}/${FILE_NAME}"

            mkdir -p "4.2/${folder}"
            local tmp
            tmp="$(mktemp)"

            echo "----"
            echo "FOLDER: $folder"
            echo "URL   : $url"
            echo "DEST  : $dest"

            local code
            code="$(curl -L -A "$UA" -sS -o "$tmp" -w "%{http_code}" "$url" || true)"
            echo "HTTP: $code"

            if [[ "$code" == "404" ]]; then
              rm -f "$tmp"
              if [[ -f "$dest" ]]; then
                rm -f "$dest"
                echo "HOSTING 404 -> DELETED from GitHub: $dest"
              else
                echo "HOSTING 404 -> already missing on GitHub: $dest"
              fi
              return 0
            fi

            if [[ "$code" != "200" ]]; then
              echo "HOSTING HTTP $code -> SKIP (no changes)"
              rm -f "$tmp"
              return 0
            fi

            if [[ ! -f "$dest" ]]; then
              mv -f "$tmp" "$dest"
              echo "HOSTING 200 + GitHub missing -> UPLOADED: $dest"
              return 0
            fi

            local sha_new sha_old
            sha_new="$(sha256sum "$tmp" | awk '{print $1}')"
            sha_old="$(sha256sum "$dest" | awk '{print $1}')"

            if [[ "$sha_new" == "$sha_old" ]]; then
              rm -f "$tmp"
              echo "HOSTING same file -> NO CHANGE: $dest"
              return 0
            fi

            mv -f "$tmp" "$dest"
            echo "HOSTING changed -> UPDATED on GitHub: $dest"
          }

          shopt -s nullglob
          detected=()
          for d in 4.2/*/ ; do
            detected+=("$(basename "$d")")
          done

          folders=("${detected[@]}" "${fallback[@]}")
          uniq=()
          for f in "${folders[@]}"; do
            [[ -z "$f" ]] && continue
            if [[ ! " ${uniq[*]} " =~ " ${f} " ]]; then
              uniq+=("$f")
            fi
          done

          echo "Folders to sync: ${uniq[*]}"
          for folder in "${uniq[@]}"; do
            sync_one "$folder"
          done

      - name: Commit & push if changed (handles non-fast-forward)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi

          git commit -m "Mirror hosting 4.2 folders" || true

          for i in 1 2 3; do
            git fetch origin main
            git rebase origin/main || (git rebase --abort && git pull --rebase origin main)
            if git push origin HEAD:main; then
              echo "Push success"
              exit 0
            fi
            echo "Push failed, retrying... ($i)"
            sleep 2
          done

          echo "Push failed after retries"
          exit 1
