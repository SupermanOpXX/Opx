name: Sync 4.2 folders (auto-detect, SHA compare)

on:
  schedule:
    - cron: "*/1 * * * *"   # every 1 minute
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync auto-detected folders (SHA + UA)
        shell: bash
        run: |
          set -euo pipefail

          BASE_URL="https://nskmedia.net/rizwan/4.2"
          FILE_NAME="libopenplatform.so"

          # 0 = delete from GitHub if hosting returns 404
          # 1 = keep existing GitHub file even if hosting returns 404
          SAFE_MODE_KEEP_ON_404=0

          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36"

          sync_one () {
            local url="$1"
            local dest="$2"

            mkdir -p "$(dirname "$dest")"
            local tmp
            tmp="$(mktemp)"

            echo "----"
            echo "URL : $url"
            echo "DEST: $dest"

            local code
            code="$(curl -L -A "$UA" -sS -o "$tmp" -w "%{http_code}" "$url" || true)"
            echo "HTTP: $code"

            if [[ "$code" == "404" ]]; then
              rm -f "$tmp"
              if [[ "$SAFE_MODE_KEEP_ON_404" == "1" ]]; then
                echo "404 received, SAFE_MODE=ON -> keeping existing file: $dest"
                return 0
              fi
              echo "Remote 404 -> deleting from repo (if exists): $dest"
              rm -f "$dest"
              return 0
            fi

            if [[ "$code" != "200" ]]; then
              echo "Download failed (HTTP $code) -> skip"
              rm -f "$tmp"
              return 0
            fi

            if [[ ! -f "$dest" ]]; then
              mv -f "$tmp" "$dest"
              echo "MISSING -> DOWNLOADED: $dest"
              return 0
            fi

            local sha_new sha_old
            sha_new="$(sha256sum "$tmp" | awk '{print $1}')"
            sha_old="$(sha256sum "$dest" | awk '{print $1}')"

            if [[ "$sha_new" == "$sha_old" ]]; then
              echo "EXISTS -> SAME SHA (no change): $dest"
              rm -f "$tmp"
              return 0
            fi

            mv -f "$tmp" "$dest"
            echo "EXISTS -> UPDATED (SHA changed): $dest"
          }

          echo "Auto-detecting folders in ./4.2/"
          shopt -s nullglob
          found=0

          for d in 4.2/*/ ; do
            found=1
            folder="$(basename "$d")"
            url="${BASE_URL}/${folder}/${FILE_NAME}"
            dest="4.2/${folder}/${FILE_NAME}"
            sync_one "$url" "$dest"
          done

          if [[ "$found" -eq 0 ]]; then
            echo "No subfolders found under 4.2/. Create folders like 4.2/GL 4.2/VNG etc."
          fi

      - name: Commit & push if changed
        shell: bash
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi

          git commit -m "Auto-sync 4.2/* (SHA compare)"
          git push
