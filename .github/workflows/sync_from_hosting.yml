name: Sync from Hosting (SHA compare)

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync files (SHA compare)
        shell: bash
        run: |
          set -euo pipefail

          sync_one () {
            local url="$1"
            local dest="$2"

            mkdir -p "$(dirname "$dest")"

            local tmp
            tmp="$(mktemp)"

            echo "----"
            echo "URL : $url"
            echo "DEST: $dest"

            # Download with HTTP status capture
            local code
            code="$(curl -L -sS -o "$tmp" -w "%{http_code}" "$url" || true)"

            if [[ "$code" == "404" ]]; then
              echo "Remote 404 -> delete from repo if exists"
              rm -f "$tmp"
              if [[ -f "$dest" ]]; then
                rm -f "$dest"
                echo "Deleted: $dest"
              else
                echo "Already missing: $dest"
              fi
              return 0
            fi

            if [[ "$code" != "200" ]]; then
              echo "Download failed (HTTP $code). Keeping existing."
              rm -f "$tmp"
              return 0
            fi

            # If file doesn't exist locally -> add
            if [[ ! -f "$dest" ]]; then
              mv -f "$tmp" "$dest"
              echo "New file added: $dest"
              return 0
            fi

            # Compare SHA
            local sha_new sha_old
            sha_new="$(sha256sum "$tmp" | awk '{print $1}')"
            sha_old="$(sha256sum "$dest" | awk '{print $1}')"

            if [[ "$sha_new" == "$sha_old" ]]; then
              echo "Same SHA -> no change"
              rm -f "$tmp"
              return 0
            fi

            # Replace if changed
            mv -f "$tmp" "$dest"
            echo "Updated (SHA changed): $dest"
          }

          # ---- ADD YOUR FILES HERE ----
          sync_one "https://nskmedia.net/rizwan/4.2/GL/libopenplatform.so"  "4.2/GL/libopenplatform.so"
          sync_one "https://nskmedia.net/rizwan/4.2/VNG/libopenplatform.so" "4.2/VNG/libopenplatform.so"

          echo "Done syncing."

      - name: Commit & push if changed
        shell: bash
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Auto-sync from hosting (SHA compare)"
          git push
