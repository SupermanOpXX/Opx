- name: Sync files (SHA compare)
  shell: bash
  run: |
    set -euo pipefail

    UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36"

    sync_one () {
      local url="$1"
      local dest="$2"

      mkdir -p "$(dirname "$dest")"
      tmp="$(mktemp)"

      echo "----"
      echo "URL : $url"

      code="$(curl -L -A "$UA" -sS -o "$tmp" -w "%{http_code}" "$url" || true)"

      echo "HTTP: $code"

      if [[ "$code" == "404" ]]; then
        echo "Remote 404 → deleting local file"
        rm -f "$tmp"
        rm -f "$dest"
        return 0
      fi

      if [[ "$code" != "200" ]]; then
        echo "Download failed (HTTP $code), skipping"
        rm -f "$tmp"
        return 0
      fi

      if [[ ! -f "$dest" ]]; then
        mv "$tmp" "$dest"
        echo "Added new file"
        return 0
      fi

      sha_new="$(sha256sum "$tmp" | awk '{print $1}')"
      sha_old="$(sha256sum "$dest" | awk '{print $1}')"

      if [[ "$sha_new" == "$sha_old" ]]; then
        echo "Same SHA → no change"
        rm -f "$tmp"
      else
        mv "$tmp" "$dest"
        echo "Updated (SHA changed)"
      fi
    }

    sync_one "https://nskmedia.net/rizwan/4.2/GL/libopenplatform.so"  "4.2/GL/libopenplatform.so"
    sync_one "https://nskmedia.net/rizwan/4.2/VNG/libopenplatform.so" "4.2/VNG/libopenplatform.so"
